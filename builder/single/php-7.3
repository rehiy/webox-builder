### Update: 2020-05-14 ###

export wk_php=php-7.3.18

wk_find_php() {

    wk__apply http://www.php.net/distributions/ ${wk_php} .tar.xz

}

wk_make_php() {

    ./configure \
        --prefix=${wbapp} \
        --libdir=${wbapp}/lib/php \
        --datadir=${wbapp}/share/php \
        --sysconfdir=${wbapp}/etc/php \
        --with-config-file-path=${wbapp}/etc/php \
        --with-config-file-scan-dir=${wbapp}/etc/php/php.d \
        --with-layout=GNU \
        --without-pear \
        --disable-rpath \
        --disable-cgi \
        --disable-opcache \
        --enable-fpm \
        --with-mysqli \
        --with-pdo-mysql \
        --with-iconv=${wbcom} \
        --with-libxml-dir=${wbcom} \
        CFLAGS="-O3" CXXFLAGS="-O3"

    make && make install
    wk__error_check ${wk_php}

    wk_make_php_ext bcmath
    wk_make_php_ext bz2 --with-bz2=${wbcom}
    wk_make_php_ext calendar
    wk_make_php_ext curl -with-curl=${wbcom}
    wk_make_php_ext exif
    wk_make_php_ext ftp --with-openssl-dir=${wbcom}
    wk_make_php_ext gd --with-freetype-dir=${wbcom} --with-jpeg-dir=${wbcom} --with-png-dir=${wbcom} --with-zlib-dir=${wbcom}
    wk_make_php_ext gettext --with-gettext=${wbcom}
    wk_make_php_ext mbstring
    wk_make_php_ext opcache
    wk_make_php_ext openssl --with-openssl=${wbcom}
    wk_make_php_ext pcntl
    wk_make_php_ext shmop
    wk_make_php_ext soap --with-libxml-dir=${wbcom}
    wk_make_php_ext sockets
    wk_make_php_ext sysvmsg
    wk_make_php_ext sysvsem
    wk_make_php_ext sysvshm
    wk_make_php_ext xmlrpc --with-libxml-dir=${wbcom} --with-iconv-dir=${wbcom}
    wk_make_php_ext zip --with-libzip=${wbcom} --with-pcre-dir=${wbcom} --with-zlib-dir=${wbcom}
    wk_make_php_ext zlib --with-zlib-dir=${wbcom}

    wk_make_php_pecl redis-5.0.2

    wk_plus_php_imagick
    wk_plus_php_maxminddb

    rm -rf ${wbapp}/etc/php

}

wk_inst_php() {

    local fine=${wbapp}/bin/php

    [ -e ${fine} ] || wk_find_php
    [ -e ${fine} ] || wk_make_php
    [ -e ${fine} ] || wk__error ${wk_php}

}

########################################################################

wk_make_php_ext() {

    local name=$1
    shift 1

    cd ${wksrc}/${wk_php}/ext/${name}

    [ -e config.m4 ] || ln config0.m4 config.m4

    ${wbapp}/bin/phpize && ./configure \
        --with-php-config=${wbapp}/bin/php-config \
        "$@" CFLAGS="-O3" CXXFLAGS="-O3"

    make && make install

    local extdir=`${wbapp}/bin/php-config --extension-dir`

    if [ ! -e ${extdir}/${name%%-*}.so ]; then
        wk__error "${wk_php} - $(pwd)"
    fi

    cd ${wksrc}/${wk_php}

}

wk_make_php_pecl() {

    wk__apply http://pecl.php.net/get/ $1 .tgz ${wk_php}/ext/$1
    rm -rf ../package.xml

    wk_make_php_ext "$@"

}

wk_plus_php_imagick() {

    if [ "$OS_TYPE" = "Darwin" ]; then
        env CPPFLAGS="-I${wbcom}/include/ImageMagick-6" \
        wk_make_php_pecl imagick-3.4.4 --with-imagick=${wbcom}
    else
        wk_make_php_pecl imagick-3.4.4 --with-imagick=${wbcom}
    fi

}

wk_plus_php_maxminddb() {

    cd ${wksrc}/${wk_php}/ext

    if [ ! -d maxminddb ]; then

        local url=https://codeload.github.com/maxmind/MaxMind-DB-Reader-php/zip/master
        local zip=$(wk__fetch ${url} ${wk_php}/ext/MaxMind-DB-Reader-php-master.zip)

        unzip -q ${zip} && mv MaxMind-DB-Reader-php-master/ext maxminddb

        wk__error_check "${wk_php} - not found maxminddb"

        rm -rf MaxMind-DB-Reader-php-master

    fi

    wk_make_php_ext maxminddb --with-maxminddb=${wbcom}

}
