#!/bin/sh
#

export APP_USER=_mysql
export APP_GROUP=_mysql

#####################################################################

app_prepare() {

    for dir in lib log run tmp; do
        [ -d ${wbapp}/var/${dir}/mysql ] ||
            mkdir -p ${wbapp}/var/${dir}/mysql
    done

    if [ ! -f ${wbapp}/var/log/mysql/error.log ]; then
        touch ${wbapp}/var/log/mysql/error.log
    fi

    chown -R $APP_USER:$APP_GROUP ${wbapp}/var/*/mysql

    if [ ! -f ${wbapp}/var/lib/mysql/ibdata1 ]; then
        ${wbapp}/sbin/mysqld --initialize \
            --basedir=${wbapp} --datadir=${wbapp}/var/lib/mysql
        if [ $? -eq 0 ]; then
            pw=`grep password ${wbapp}/var/log/mysql/error.log`
            echo "MySQL root password is \033[32m${pw##* }\033[0m"
        fi
    fi

}

#####################################################################

[ "$1" = "prepare" ] && app_prepare
