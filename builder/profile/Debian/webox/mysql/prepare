#!/bin/sh
#

export APP_USER=mysql
export APP_GROUP=mysql

#####################################################################

app_prepare() {

    if ! grep $APP_GROUP /etc/group >/dev/null; then
        groupadd $APP_GROUP -g 77
    fi

    if ! grep $APP_USER /etc/passwd >/dev/null; then
        useradd $APP_USER -u 77 -g 77
        usermod $APP_USER -d ${wbapp} -s /usr/sbin/nologin
    fi

    [ -d ${wbapp}/var/lib/mysql ] || mkdir -p ${wbapp}/var/lib/mysql
    [ -d ${wbapp}/var/log/mysql ] || mkdir -p ${wbapp}/var/log/mysql
    [ -d ${wbapp}/var/run/mysql ] || mkdir -p ${wbapp}/var/run/mysql
    [ -d ${wbapp}/var/tmp/mysql ] || mkdir -p ${wbapp}/var/tmp/mysql

    if [ ! -f ${wbapp}/var/log/mysql/error.log ]; then
        touch ${wbapp}/var/log/mysql/error.log
    fi

    if [ ! -f ${wbapp}/var/lib/mysql/ibdata1 ]; then
        ${wbapp}/sbin/mysqld --initialize-insecure \
            --basedir=${wbapp} --datadir=${wbapp}/var/lib/mysql
    fi

    chown -R $APP_USER:$APP_USER ${wbapp}/var/*/mysql

}

#####################################################################

[ "$1" = "prepare" ] && app_prepare
