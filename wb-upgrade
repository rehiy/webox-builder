#!/bin/bash
#

####################################################################

cd ~

plat=$(uname -s)-$(uname -m)
name=Webox-${plat}-v5.0902.tgz

if [ $(which wget) ]; then
    wget -c -O ${name} http://dev.anrip.com/webox/${name}
else
    curl -C - -o ${name} http://dev.anrip.com/webox/${name}
fi

tar -xvf ${name}
rm -rf ${name}

chown -R 0:0  srv
chmod -R 0777 srv/webroot/*

####################################################################

[ -x /srv/service ] && /srv/service stop

for x in php5 nginx mysql redis webox; do
    mkdir -p /srv/backup/{etc,var}/${x}
    mv /srv/${x}/etc /srv/backup/etc/${x}
    mv /srv/${x}/var /srv/backup/var/${x}
done

rm -rf srv/*/{etc,var} srv/webroot
cp -av srv/* /srv/
rm -rf srv/

for x in webox redis mysql nginx php5; do
    mv /srv/backup/var/${x} /srv/${x}/var
    mv /srv/backup/etc/${x} /srv/webox/etc
    ln -s /srv/webox/etc/${x} /srv/${x}/etc
done

####################################################################

[ -x /srv/service ] && /srv/service start

if [ -x /usr/sbin/service ]; then
    /srv/webox/bin/wkit service_setup
fi
